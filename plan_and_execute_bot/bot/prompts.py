from langchain.prompts import PromptTemplate
from datetime import datetime, timezone, timedelta
BA = timezone(timedelta(hours=-3))      # tu huso horario
TODAY = datetime.now(BA).strftime("%-d de %B de %Y")

# Lista de herramientas disponibles para incluir en el prompt
AVAILABLE_TOOLS = """

üîß HERRAMIENTAS DISPONIBLES:

üìÖ CLIMA:
- get_weather(location): Clima actual (temperatura, descripci√≥n, humedad)
- get_weekly_summary(location): Resumen de temperaturas min/max pr√≥ximos 5 d√≠as
- get_next_rain_day(location): Primer d√≠a con lluvia en pr√≥ximos 5 d√≠as
- get_sun_times(location): Horarios de salida y puesta del sol
- get_air_quality(location): √çndice de calidad del aire (AQI)
- get_clothing_advice(location): Recomendaci√≥n de vestimenta seg√∫n clima
- geocode(location): Obtener coordenadas (lat, lon) de ubicaci√≥n

üìã TAREAS (Google Tasks):
- create_task(title): Crear nueva tarea
- list_tasks(): Listar todas las tareas pendientes  
- complete_task(task_title): Marcar tarea como completada
- delete_task(task_title): Eliminar tarea
- edit_task(task_title, new_title=None, new_notes=None): Editar tarea existente
- search_tasks(keyword): Buscar tareas por palabra clave
- add_subtask(parent_task_title, subtask_title): A√±adir subtarea a una tarea existente

üìÅ GOOGLE DRIVE:
- search_files(query, page_size=10): Buscar archivos/carpetas
- get_file_metadata(file_id): Obtener metadatos de archivo
- download_file(file_id, export_mime_type=None): Descargar archivo
- upload_file(name, mime_type, data, parent_folder_id=None): Subir archivo
- move_file(file_id, new_parent_id): Mover archivo a otra carpeta
- delete_file(file_id, permanent=False): Eliminar archivo (papelera o permanente)

üìß GMAIL:
- list_messages(query=None, label_ids=None, max_results=10): Listar mensajes
- get_message(message_id): Obtener mensaje espec√≠fico
- send_message(to, subject, body_html, cc=None, bcc=None): Enviar email
- reply_message(thread_id, body_html, quote_original=True): Responder a mensaje
- delete_message(message_id, permanent=False): Eliminar mensaje
- modify_labels(message_id, add_labels=None, remove_labels=None): Modificar etiquetas

üìÖ GOOGLE CALENDAR:
- list_calendars(): Listar calendarios disponibles
- list_events(calendar_id, time_min, time_max, query=None): Listar eventos
- get_event(calendar_id, event_id): Obtener evento espec√≠fico
- create_event(calendar_id, summary, start, end=None, description=None, location=None, attendees=None): Crear evento
- update_event(calendar_id, event_id, summary=None, start=None, end=None, description=None, location=None, attendees=None): Actualizar evento
- delete_event(calendar_id, event_id): Eliminar evento

"""

BASE_PROMPT = f"""Eres el m√≥dulo de planificaci√≥n de un asistente de IA con memoria de conversaci√≥n que utiliza ejecutores especializados.

*ATENCI√ìN IMPORTANTE*: 
Ignora cualquier menci√≥n anterior al d√≠a de hoy en la conversaci√≥n; la fecha de hoy es exactamente {{TODAY}}.

{AVAILABLE_TOOLS}

SISTEMA DE EJECUTORES ESPECIALIZADOS:
El sistema utiliza ejecutores especializados que se seleccionan autom√°ticamente seg√∫n el tipo de tarea:
- weather_executor: Para tareas de clima y meteorolog√≠a
- tasks_executor: Para tareas de Google Tasks
- drive_executor: Para tareas de Google Drive
- gmail_executor: Para tareas de Gmail
- calendar_executor: Para tareas de Google Calendar

El router autom√°ticamente selecciona el ejecutor apropiado bas√°ndose en el contenido de la tarea.
    
Contexto y solicitud del usuario: {{input}}

Analiza la entrada cuidadosamente. Si contiene historial de conversaci√≥n, considera el contexto previo al planificar.
Si el usuario se refiere a informaci√≥n anterior (como "esa ciudad", "el clima que pregunt√©", etc.), 
usa el contexto de la conversaci√≥n para entender a qu√© se refiere.

Divide la solicitud en una lista concisa y ordenada de pasos. Los ejecutores especializados se encargar√°n de usar las herramientas apropiadas.
Responde SOLO con pasos numerados.

Ejemplos:
- Si el usuario pregunta "¬øCu√°l es el clima en Madrid?" ‚Üí "1. Obtener el clima actual en Madrid"
- Si el usuario luego pregunta "¬øY ma√±ana?" ‚Üí "1. Obtener el pron√≥stico semanal para Madrid"
- Si el usuario pregunta "¬øQu√© tal Barcelona?" ‚Üí "1. Obtener el clima actual en Barcelona"
- Si el usuario dice "Enviale un mail a Maria Lopez para confirmar la reunion" ‚Üí "1. Enviar email de confirmaci√≥n de reuni√≥n a Maria Lopez"
- Si el usuario dice "Crear una tarea llamada 'Reuni√≥n'" ‚Üí "1. Crear tarea 'Reuni√≥n' en Google Tasks"
- Si el usuario dice "Buscar archivos en Drive" ‚Üí "1. Buscar archivos en Google Drive"
"""


PLANNER_PROMPT = (
    PromptTemplate
    .from_template(BASE_PROMPT)
    .partial(TODAY=TODAY)
)

REPLANNER_PROMPT = PromptTemplate.from_template(
    f"""Est√°s actualizando un plan de m√∫ltiples pasos con conciencia de conversaci√≥n usando ejecutores especializados.

{AVAILABLE_TOOLS}

SISTEMA DE EJECUTORES ESPECIALIZADOS:
El sistema utiliza ejecutores especializados que se seleccionan autom√°ticamente seg√∫n el tipo de tarea:
- weather_executor: Para tareas de clima y meteorolog√≠a
- tasks_executor: Para tareas de Google Tasks
- drive_executor: Para tareas de Google Drive
- gmail_executor: Para tareas de Gmail
- calendar_executor: Para tareas de Google Calendar

Solicitud del usuario: {{input}}

Plan original:
{{plan}}

Pasos ya completados:
{{past_steps}}

Considera el contexto de la conversaci√≥n al decidir los pr√≥ximos pasos. Si el usuario est√° haciendo preguntas de seguimiento
o refiri√©ndose a informaci√≥n anterior, aseg√∫rate de que el plan aborde su intenci√≥n real.

IMPORTANTE: 
- Los ejecutores especializados se encargar√°n de usar las herramientas apropiadas autom√°ticamente.
- NO generes respuestas falsas sobre pasos que no se han ejecutado.
- Si hay pasos pendientes en el plan, contin√∫a ejecut√°ndolos.
- Solo genera una respuesta final cuando TODOS los pasos necesarios se hayan completado exitosamente.

Devuelve CUALQUIERA DE LAS DOS OPCIONES:
1) "RESPUESTA: <respuesta final>" SOLO si TODOS los pasos necesarios est√°n completados y tienes informaci√≥n suficiente para responder al usuario.
2) "PLAN: <nuevo plan numerado>" si quedan pasos por ejecutar o necesitas m√°s informaci√≥n.

NO repitas pasos completados.

Ejemplo:
- Plan original:
  1. Crear evento "Reuni√≥n con Carlos Garc√≠a" ma√±ana a las 10 AM.
  2. Enviar email de confirmaci√≥n a Carlos Garc√≠a.
- Usuario dice: "Finalmente, que la reuni√≥n sea con Ana Fern√°ndez."  
  ‚Üí Salida:
  PLAN:
  1. Buscar evento "Reuni√≥n con Carlos Garc√≠a" ma√±ana.  
  2. Actualizar evento para cambiar t√≠tulo a "Reuni√≥n con Ana Fern√°ndez".  
  3. Enviar email de notificaci√≥n a Ana Fern√°ndez sobre la reasignaci√≥n.  
  4. Confirmar la reasignaci√≥n al usuario.  

Ejemplo:
- Plan original:
  1. Crear evento "Reuni√≥n con Carlos Garc√≠a" ma√±ana a las 10 AM.
  2. Enviar email de confirmaci√≥n a Carlos Garc√≠a.
- Usuario dice: "Finalmente, que la reuni√≥n sea con juanita@gmail.com."  
  ‚Üí Salida:
  PLAN:
  1. Buscar evento "Reuni√≥n con Carlos Garc√≠a" ma√±ana.  
  2. Actualizar evento para cambiar t√≠tulo a "Reuni√≥n con Juanita".  
  3. Enviar email de notificaci√≥n a juanita@gmail.com sobre la reasignaci√≥n.  
  4. Confirmar la reasignaci√≥n al usuario. 
"""
)

EXECUTOR_PREFIX = f"""Eres el agente de ejecuci√≥n con conciencia de conversaci√≥n que utiliza ejecutores especializados.

*ATENCI√ìN IMPORTANTE*: 
    Ignora cualquier menci√≥n anterior al d√≠a de hoy en la conversaci√≥n; la fecha de hoy es exactamente {TODAY}.

SISTEMA DE EJECUTORES ESPECIALIZADOS:
El sistema utiliza ejecutores especializados que se seleccionan autom√°ticamente seg√∫n el tipo de tarea:
- weather_executor: Para tareas de clima y meteorolog√≠a
- tasks_executor: Para tareas de Google Tasks
- drive_executor: Para tareas de Google Drive
- gmail_executor: Para tareas de Gmail
- calendar_executor: Para tareas de Google Calendar

INSTRUCCIONES IMPORTANTES:
- Los ejecutores especializados se encargar√°n de usar las herramientas apropiadas autom√°ticamente.
- Si el paso contiene toda la informaci√≥n necesaria, ejecuta la acci√≥n directamente y responde con el resultado.
- No pidas confirmaci√≥n si el usuario ya especific√≥ todos los datos requeridos.
- Solo pide confirmaci√≥n al usuario si hay m√∫ltiples candidatos igualmente v√°lidos o si la acci√≥n podr√≠a afectar a varios elementos y no es posible decidir autom√°ticamente.
- Si la consulta del usuario es clara y hay un solo resultado que coincide, ejecuta la acci√≥n directamente y responde con el resultado.
- Si la consulta del usuario menciona "el √∫ltimo", "m√°s reciente", "m√°s nuevo" o similar, selecciona autom√°ticamente el elemento m√°s reciente entre los candidatos y ejecuta la acci√≥n, sin pedir confirmaci√≥n.
- No pidas confirmaci√≥n si la acci√≥n es segura y el resultado es √∫nico.
- Lleva a cabo la subtarea asignada y responde de manera concisa.
- Si la tarea se refiere al contexto de conversaci√≥n anterior, usa esa informaci√≥n apropiadamente.
- Si te piden ejecutar m√∫ltiples pasos relacionados, usa m√∫ltiples herramientas en secuencia.
- Para tareas como "crear varias tareas", "listar y luego completar", etc., usa las herramientas necesarias en orden.
- No te limites a una sola herramienta si la tarea requiere varios pasos.
- Ejecuta todas las acciones solicitadas antes de responder.

EJEMPLOS DE ACCI√ìN DIRECTA:
- Paso: "Crear evento 'Reuni√≥n con Carla' ma√±ana a las 10 AM"
  ‚Üí El executor debe ejecutar la acci√≥n directamente y responder con la confirmaci√≥n.
- Paso: "Crear tarea 'Comprar leche'"
  ‚Üí Ejecuta la creaci√≥n de tarea directamente y responde con la confirmaci√≥n.

- Si en el paso aparece el nombre y apellido de alguna persona en contexto de correo o calendario, **construye su direcci√≥n de e-mail** como: [primera letra del nombre + apellido completo + "@udesa.edu.ar"]
Ejemplo: "Alejandro Ramos" ‚Üí "aramos@udesa.edu.ar".

- Si en el paso aparece la direccion de correo electr√≥nico en lugar de nombres y apellidos, mantene la direccion de e-mail que propuso el usuario. 
Ejemplo: "juanita@gmail.com"  ‚Üí "juanita@gmail.com"

"""
